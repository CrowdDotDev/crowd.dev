import { AxiosError, AxiosRequestConfig } from 'axios'

import telemetry from '@crowd/telemetry'
import { RateLimitError } from '@crowd/types'

import { IProcessStreamContext } from '../../../types'

export const handleDiscordError = (
  err: AxiosError,
  config: AxiosRequestConfig,
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  input: any,
  ctx: IProcessStreamContext,
) => {
  const logger = ctx.log

  let url = config.url
  if (config.params) {
    const queryParams: string[] = []
    for (const [key, value] of Object.entries(config.params)) {
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      queryParams.push(`${key}=${encodeURIComponent(value as any)}`)
    }

    url = `${config.url}?${queryParams.join('&')}`
  }

  if (err && err.response && err.response.status === 429) {
    telemetry.increment('discord.api.rate_limit', 1)
    let rateLimitResetSeconds = 60

    if (err.response.headers['x-ratelimit-reset-after']) {
      rateLimitResetSeconds = parseInt(err.response.headers['x-ratelimit-reset-after'], 10)
    }

    return new RateLimitError(rateLimitResetSeconds, url, err)
  }

  if (err && err.response && err.response.status === 403) {
    logger.warn('No access to resourse, ignoring it', { input, err })
    return undefined
  }

  logger.error(err, { input }, `Error while calling Discord API URL: ${url}`)
  return err
}

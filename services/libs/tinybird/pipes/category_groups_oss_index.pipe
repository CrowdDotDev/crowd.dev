NODE category_groups_oss_index_agregates
SQL >
    SELECT categoryGroupId, coalesce(sum(contributorCount), 0) as "totalContributors"
    FROM segments_aggregates_with_ids_datasource
    WHERE categoryGroupId != ''
    GROUP BY categoryGroupId
    ORDER BY totalContributors DESC

NODE category_groups_oss_index_projects_data
SQL >
    SELECT insightsProjects.id, insightsProjects.name, insightsProjects.logoUrl
    FROM insightsProjects FINAL

NODE category_groups_oss_index_collections_data
SQL >
    SELECT collections.id, collections.name FROM collections FINAL

NODE category_groups_oss_index_projects
SQL >
    SELECT
        topProjects.categoryGroupId,
        topProjects.projectId,
        topProjects.totalContributors,
        pd.name AS projectName,
        pd.logoUrl AS projectLogo
    FROM
        (
            SELECT
                categoryGroupId,
                projectId,
                sum(contributorCount) AS totalContributors,
                ROW_NUMBER() OVER (
                    PARTITION BY categoryGroupId ORDER BY sum(contributorCount) DESC
                ) AS rn
            FROM segments_aggregates_with_ids_datasource
            WHERE categoryGroupId != '' AND projectId != ''
            GROUP BY categoryGroupId, projectId
        ) topProjects
    JOIN category_groups_oss_index_projects_data pd ON pd.id = topProjects.projectId
    WHERE topProjects.rn <= 5

NODE category_groups_oss_index_collections
SQL >
    SELECT
        topCollections.categoryGroupId,
        topCollections.collectionId,
        topCollections.totalContributors,
        cd.name AS collectionName
    FROM
        (
            SELECT
                categoryGroupId,
                collectionId,
                sum(contributorCount) AS totalContributors,
                ROW_NUMBER() OVER (
                    PARTITION BY categoryGroupId ORDER BY sum(contributorCount) DESC
                ) AS rn
            FROM segments_aggregates_with_ids_datasource
            WHERE categoryGroupId != '' AND collectionId != ''
            GROUP BY categoryGroupId, collectionId
        ) topCollections
    JOIN category_groups_oss_index_collections_data cd ON cd.id = topCollections.collectionId
    WHERE topCollections.rn <= 5

NODE category_groups_oss_index_category_groups_data
SQL >
    %
    SELECT categoryGroups.id, categoryGroups.name, categoryGroups.type
    FROM categoryGroups FINAL
    {% if defined(type) %}
        WHERE
            categoryGroups.type
            = {{ String(type, description="Filter category group type", required=False) }}
    {% end %}

NODE category_groups_oss_index_results
SQL >
    SELECT
        a.categoryGroupId as "id",
        cgd.name as "name",
        cgd.type as "type",
        a.totalContributors,
        c.topCollections,
        p.topProjects
    FROM category_groups_oss_index_agregates a
    LEFT JOIN
        (
            SELECT
                categoryGroupId,
                groupArray((collectionId, totalContributors, collectionName)) AS topCollections
            FROM category_groups_oss_index_collections
            GROUP BY categoryGroupId
        ) c USING (categoryGroupId)
    LEFT JOIN
        (
            SELECT
                categoryGroupId,
                groupArray((projectId, totalContributors, projectName, projectLogo)) AS topProjects
            FROM category_groups_oss_index_projects
            GROUP BY categoryGroupId
        ) p USING (categoryGroupId)
    JOIN
        category_groups_oss_index_category_groups_data
        cgd ON category_groups_oss_index_category_groups_data.id = a.categoryGroupId

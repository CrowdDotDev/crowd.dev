<template>
  <el-popover
    placement="right-end"
    :width="260"
    trigger="click"
    popper-class="!pt-2 !px-1 !pb-1 transform translate-x-1"
    @show="isDropdownOpen = true"
    @hide="isDropdownOpen = false"
  >
    <template #reference>
      <div class="-mr-4 pr-4">
        <el-tooltip
          :disabled="!props.collapsed || isDropdownOpen"
          :hide-after="50"
          content="Help & support"
          effect="dark"
          placement="right"
          raw-content
        >
          <div
            class="rounded-md h-8 transition !text-gray-400 flex items-center
          group whitespace-nowrap flex-nowrap px-1.5 hover:bg-gray-50 mb-2 cursor-pointer overflow-hidden"
            :class="isDropdownOpen ? 'bg-gray-100' : ''"
          >
            <i class="ri-question-line text-lg mr-3" />
            <span v-if="!props.collapsed" class="text-sm !text-gray-900">
              Help & support
            </span>
          </div>
        </el-tooltip>
      </div>
    </template>

    <div class="-mb-">
      <div class="pt-1 pb-2 px-4">
        <p class="uppercase text-2xs font-semibold tracking-1 text-gray-400 leading-6">
          Help & Support
        </p>
      </div>
      <cr-menu-links
        :collapsed="false"
        :links="supportMenu"
        link-class="!p-3 !h-10 !mb-1 !text-xs"
        icon-class="!text-base"
      />
      <el-divider class="!my-2 border-gray-100 -mx-1" />
      <a
        id="menu-system-status"
        href="https://status.crowd.dev/"
        target="_blank"
        rel="noopener noreferrer"
        class="rounded-md h-10 transition !text-gray-400 flex items-center justify-between
          group whitespace-nowrap flex-nowrap mx-1 hover:bg-gray-50 mb-2 cursor-pointer overflow-hidden"
      >
        <div class="flex items-center justify-between grow">
          <span class="text-gray-900 pl-3 text-xs">
            System Status
          </span>
          <app-system-status v-if="status" :status="status" class="mr-2" />
        </div>
      </a>
    </div>
  </el-popover>
</template>

<script setup lang="ts">
import { ref, watch } from 'vue';
import CrMenuLinks from '@/modules/layout/components/menu/menu-links.vue';
import { supportMenu } from '@/modules/layout/config/menu';
import AppSystemStatus from '@/modules/layout/components/system-status/system-status.vue';
import { LayoutService } from '@/modules/layout/layout-service';
import { Status } from '@/modules/layout/types/SystemStatus';

const props = defineProps<{
  collapsed: boolean
}>();

const isDropdownOpen = ref<boolean>(false);
const status = ref<Status>();

watch(isDropdownOpen, (isOpen) => {
  if (isOpen) {
    LayoutService.getSystemStatus().then((response) => { status.value = response; });
  }
});
</script>

<script lang="ts">
export default {
  name: 'CrMenuSupport',
};
</script>

<template>
  <div>
    <el-upload
      ref="files"
      :accept="accept"
      :file-list="fileList"
      :http-request="uploadFromRequest"
      :limit="max"
      :on-error="onError"
      :on-preview="download"
      :on-remove="onRemove"
      :on-success="onSuccess"
      action
    >
      <el-button
        :disabled="loading || isFull"
        size="small"
        :class="btnClass"
      >
        <i class="ri-upload-2-line mr-2" />
        {{ text }}
      </el-button>
    </el-upload>
  </div>
</template>

<script>
import { FileUploader } from '@/shared/file-upload/file-uploader';
import Errors from '@/shared/error/errors';

export default {
  name: 'AppFileUpload',

  props: {
    text: {
      type: String,
      required: false,
      default: 'Upload',
    },
    storage: {
      type: String,
      required: true,
    },
    value: {
      type: Array,
      default: () => [],
      required: false,
    },
    formats: {
      type: String,
      default: null,
      required: false,
    },
    max: {
      type: Number,
      required: true,
    },
    btnClass: {
      type: String,
      default: null,
    },
  },
  emits: ['update:modelValue'],

  data() {
    return {
      fileList: (this.value || []).map((item) => ({
        ...item,
        url: item.downloadUrl,
      })),
      loading: false,
    };
  },

  computed: {
    isFull() {
      const hasInputReference = Boolean(this.$refs.files);

      return (
        (this.max
          && hasInputReference
          && this.$refs.files.uploadFiles.length
            >= this.max)
        || (!hasInputReference
          && (this.value || []).length >= this.max)
      );
    },

    accept() {
      return this.formats
        ? this.formats
          .map((format) => `.${format}`)
          .join(',')
        : undefined;
    },
  },

  methods: {
    async uploadFromRequest(request) {
      this.loading = true;
      return FileUploader.uploadFromRequest(request, {
        storage: this.storage,
        formats: this.formats,
      });
    },

    onSuccess(file) {
      if (!file) {
        return;
      }

      this.$emit('update:modelValue', [
        ...(this.value || []),
        file,
      ]);
      this.loading = false;
    },

    onError(error) {
      Errors.showMessage(error);
      this.loading = false;
    },

    onRemove(file, files) {
      this.$emit(
        'update:modelValue',
        (this.value || []).filter((item) => files.some((f) => (f.response
          ? f.response.id === item.id
          : file.id === item.id))),
      );
    },

    download(file) {
      window.open(file.url, '_blank');
    },
  },
};
</script>
